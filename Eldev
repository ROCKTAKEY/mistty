; -*- mode: emacs-lisp; lexical-binding: t -*-

(eldev-use-package-archive 'melpa)

(setq eldev-build-treat-warnings-as-errors t)
(setf eldev-project-loading-mode 'byte-compiled)

(eldev-use-plugin 'autoloads)

(eldev-defoption mistty-test-bash-exe (&optional path)
  "Tests look for Bash at PATH."
  :options        (--bash)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-bash-exe (executable-find path)))

(eldev-defoption mistty-test-zsh-exe (&optional path)
  "Tests look for Zsh at PATH. Empty to skip zsh tests."
  :options        (--zsh)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-zsh-exe (executable-find path)))

(eldev-defoption mistty-test-fish-exe (&optional path)
  "Tests look for Fish at PATH. Empty to skip fish tests." 
  :options        (--fish)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-fish-exe (executable-find path)))

(eldev-defoption mistty-test-python-exe (&optional path)
  "Tests look for Python at PATH."
  :options        (--python)
  :optional-value PATH
  :for-command    test
  (setq mistty-test-python-exe (executable-find path)))

(eldev-defbuilder mistty-builder-build-info (source target)
  :short-name     "SPHINX"
  :message        source-and-target
  :type           many-to-one
  :source-files   "docs/source/*.rst"
  :targets        ("mistty.texi")
  :collect        ":default"
  :define-cleaner (mistty-cleaner-texi :default t)
  (eldev-call-process "sphinx-build" '("-M" "texinfo" "docs/source" "docs/build")
                      :forward-output t
                      :die-on-error t)
  (copy-file "docs/build/texinfo/mistty.texi" "mistty.texi"))

(eldev-defcommand mistty-html-doc (&rest parameters)
  "Generate documentation HTML into docs/build/html."
  :command        documentation
  :aliases        (html)
  (eldev-call-process "sphinx-build" '("-M" "html" "docs/source" "docs/build")
  :forward-output t
  :die-on-error t))

(eldev-defcleaner mistty-cleaner-docs ()
  "Delete Sphinx build dir"
  :default t
  '("docs/build"))
